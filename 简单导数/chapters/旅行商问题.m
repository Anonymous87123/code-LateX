% 世界前100名大学旅行商问题 (TSP) - 基于真实经纬度与球面距离
clear; clc; close all;

% 1. 载入真实数据：大学名称, 纬度(Latitude), 经度(Longitude)
% 数据说明：北纬为正，南纬为负；东经为正，西经为负。
data = {
    '哈佛大学', 42.373, -71.110; '斯坦福大学', 37.427, -122.169; '牛津大学', 51.754, -1.254; '剑桥大学', 52.204, 0.114; '麻省理工学院', 42.360, -71.092;
    '东京大学', 35.712, 139.762; '哥伦比亚大学', 40.807, -73.962; '巴黎大学', 48.849, 2.343; '耶鲁大学', 41.316, -72.922; '普林斯顿大学', 40.343, -74.651;
    '加州伯克利分校', 37.871, -122.258; '莫斯科大学', 55.702, 37.530; '海德堡大学', 49.410, 8.706; '康乃尔大学', 42.453, -76.473; '爱丁堡大学', 55.944, -3.189;
    '芝加哥大学', 41.789, -87.599; '鲁汶大学', 50.879, 4.700; '莱顿大学', 52.158, 4.481; '波鸿大学', 51.444, 7.261; '布朗大学', 41.826, -71.402;
    '马德里大学', 40.448, -3.727; '加州理工学院', 34.137, -118.125; '波伦亚大学', 44.496, 11.353; '早稻田大学', 35.709, 139.719; '格廷根大学', 51.540, 9.935;
    '巴黎高师', 48.842, 2.344; '约翰霍布金斯大学', 39.329, -76.620; '庆应义塾大学', 35.648, 139.742; '彼得堡大学', 59.938, 30.299; '科英布拉大学', 40.207, -8.426;
    '伦敦大学', 51.522, -0.129; '达特茅斯学院', 43.704, -72.288; '慕尼黑大学', 48.150, 11.580; '罗马大学', 41.903, 12.515; '维也纳大学', 48.213, 16.360;
    '北京大学', 39.991, 116.305; 'UBC大学', 49.260, -123.246; '莱斯大学', 29.717, -95.401; '斯德哥尔摩大学', 59.363, 18.058; '都柏林圣三一', 53.344, -6.258;
    '哥本哈根大学', 55.679, 12.536; '巴黎理工学校', 48.713, 2.210; '柏林工业大学', 52.512, 13.326; '悉尼大学', -33.888, 151.187; '爱资哈尔大学', 30.045, 31.262;
    '杜克大学', 36.001, -78.938; '清华大学', 40.000, 116.326; '南加州大学', 34.022, -118.285; '多伦多大学', 43.662, -79.395; '比萨高师', 43.719, 10.400;
    '雅典大学', 37.980, 23.733; '萨尔福大学', 53.483, -2.274; '京都大学', 35.026, 135.780; '法国国立行政学院', 48.581, 7.737; '法兰克福大学', 50.126, 8.666;
    '麦吉尔大学', 45.504, -73.577; '新加坡国立大学', 1.296, 103.776; '安卡拉大学', 39.937, 32.829; '朱拉隆功大学', 13.738, 100.530; '西北大学', 42.055, -87.675;
    '博科尼大学', 45.449, 9.189; '萨拉曼卡大学', 40.961, -5.667; '维也纳音乐表演大学', 48.201, 16.382; '赫尔辛基大学', 60.169, 24.938; '瑞典皇家工学院', 59.349, 18.069;
    '华沙大学', 52.239, 21.018; '阿马斯特学院', 42.370, -72.516; '柏林自由大学', 52.453, 13.295; '真纳大学', 33.748, 73.137; '宾夕法尼亚大学', 39.952, -75.193;
    '筑波大学', 36.110, 140.100; '冰岛大学', 64.140, -21.949; '珀杜大学', 40.425, -86.920; '巴西利亚大学', -15.763, -47.870; '凡德比特大学', 36.144, -86.802;
    '波士顿大学', 42.350, -71.105; '布鲁塞尔自由大学', 50.813, 4.381; '特拉华大学', 39.678, -75.750; '洛桑高等工科学校', 46.519, 6.566; '密执安大学', 42.278, -83.738;
    '犹他大学', 40.764, -111.842; '开罗大学', 30.027, 31.208; '北卡教堂山分校', 35.904, -79.046; '尼赫鲁大学', 28.539, 77.166; '贝鲁特美国大学', 33.898, 35.480;
    '索非亚大学', 42.693, 23.334; '乔治华盛顿大学', 38.899, -77.046; '科尔多瓦大学', -31.433, -64.193; '苏黎世联邦理工', 47.376, 8.547; '明斯特大学', 51.963, 7.621;
    '乔治梅森大学', 38.831, -77.307; '伊利诺斯大学', 40.101, -88.227; '德里大学', 28.687, 77.208; '菲律宾大学', 14.654, 121.068; '巴黎高矿', 48.845, 2.339;
    '美国郡礼学院', 41.745, -92.718; '澳大利亚国立大学', -35.277, 149.118; '乔治城大学', 38.907, -77.072; '卡塔尔大学', 25.374, 51.490; '旁遮普大学', 31.500, 74.300
};

N = size(data, 1);
univ_names = data(:, 1);
lats = cell2mat(data(:, 2));
lons = cell2mat(data(:, 3));

% 2. 预计算距离矩阵 (计算地球上任意两点的大圆距离)
disp('正在构建球面距离矩阵...');
dist_matrix = zeros(N, N);
for i = 1:N
    for j = 1:N
        if i ~= j
            dist_matrix(i,j) = haversine(lats(i), lons(i), lats(j), lons(j));
        end
    end
end

% 3. 模拟退火算法 (Simulated Annealing) 参数初始化
T0 = 10000;      % 初始温度
T_end = 1e-4;    % 终止温度
alpha = 0.99;    % 降温系数
L = 1000;        % 内循环迭代次数

% 生成随机初始路线
rng('shuffle');
current_tour = randperm(N);
best_tour = current_tour;

% 计算初始总距离 (使用线性索引以加速计算)
idx = (current_tour([2:end, 1]) - 1) * N + current_tour;
current_dist = sum(dist_matrix(idx));
best_dist = current_dist;

% 4. 开始退火优化
disp('开始模拟退火寻优，请稍候...');
T = T0;
while T > T_end
    for iter = 1:L
        % 产生新解：使用 2-Opt 邻域（随机反转路线中的一段）
        r = randi(N, 1, 2);
        while r(1) == r(2)
            r = randi(N, 1, 2);
        end
        i1 = min(r); i2 = max(r);
        
        new_tour = current_tour;
        new_tour(i1:i2) = new_tour(i2:-1:i1); % 翻转片段
        
        % 评估新解距离
        idx_new = (new_tour([2:end, 1]) - 1) * N + new_tour;
        new_dist = sum(dist_matrix(idx_new));
        
        % Metropolis 准则接受新解
        delta = new_dist - current_dist;
        if delta < 0 || exp(-delta / T) > rand()
            current_tour = new_tour;
            current_dist = new_dist;
            
            % 记录全局最优
            if current_dist < best_dist
                best_tour = current_tour;
                best_dist = current_dist;
            end
        end
    end
    T = T * alpha; % 降温
end

fprintf('优化完成！100所大学的最短遍历路线总距离约为: %.2f km\n', best_dist);

% 5. 结果可视化：绘制世界地图路线图
figure('Name', '世界前100大学 TSP 最优路线', 'Position', [100, 100, 1000, 500]);

% 如果有 Mapping Toolbox 可以用下面代码画出精美的真实海岸线
% [coastlat, coastlon] = coastlines; 
% plot(coastlon, coastlat, 'Color', [0.8 0.8 0.8]); hold on;

% 绘制所有的节点(大学)位置 (经度为X, 纬度为Y)
scatter(lons, lats, 25, 'b', 'filled'); hold on;

% 将访问路线连接起来
route_lons = lons(best_tour); route_lats = lats(best_tour);
% 把起点和终点连起来形成闭环
route_lons(end+1) = route_lons(1); route_lats(end+1) = route_lats(1);

plot(route_lons, route_lats, 'r-', 'LineWidth', 1.2);
plot(route_lons(1), route_lats(1), 'k*', 'MarkerSize', 10); % 标记起点

% 添加少部分名字标签防止密集重叠
for i = 1:5:N
    text(lons(best_tour(i))+2, lats(best_tour(i))+2, univ_names{best_tour(i)}, 'FontSize', 8);
end

title(sprintf('世界百强名校环球旅行最优路线 (总距离: %.1f km)', best_dist), 'FontSize', 12);
xlabel('Longitude (经度)');
ylabel('Latitude (纬度)');
grid on; axis equal;
axis([-180 180 -60 80]);

% ================= 自定义函数库 ================= %
function d = haversine(lat1, lon1, lat2, lon2)
    % Haversine formula (计算球面上任意两点的大圆距离)
    R = 6371; % 地球平均半径 (km)
    
    % 转换为弧度
    lat1 = deg2rad(lat1);
    lon1 = deg2rad(lon1);
    lat2 = deg2rad(lat2);
    lon2 = deg2rad(lon2);
    
    dLat = lat2 - lat1;
    dLon = lon2 - lon1;
    
    a = sin(dLat/2)^2 + cos(lat1) * cos(lat2) * sin(dLon/2)^2;
    c = 2 * atan2(sqrt(a), sqrt(1-a));
    d = R * c;
end